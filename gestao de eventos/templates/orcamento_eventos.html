{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-file-earmark-text"></i> Orçamento de Eventos</h1>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h4 class="my-0 fw-normal">Criar Novo Orçamento</h4>
        </div>
        <div class="card-body">
            <form action="{{ url_for('orcamento_eventos') }}" method="POST">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="tipo_evento" class="form-label fw-semibold">Tipo de Evento</label>
                        <select class="form-select" id="tipo_evento" name="tipo_evento" required>
                            <option value="" selected disabled>Selecione...</option>
                            <option>Casamento</option>
                            <option>Festa de 15 Anos</option>
                            <option>Aniversário Infantil</option>
                            <option>Aniversário Adulto</option>
                            <option>Evento Corporativo</option>
                            <option>Formatura</option>
                            <option>Outro/Personalizado</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label for="nome_evento" class="form-label fw-semibold">Nome do Evento</label>
                        <input type="text" class="form-control" id="nome_evento" name="nome_evento" required>
                    </div>
                    <div class="col-md-12">
                        <label for="cliente_id" class="form-label fw-semibold">Cliente</label>
                        <select class="form-select" id="cliente_id" name="cliente_id" required>
                            <option selected disabled value="">Selecione...</option>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="data_evento" class="form-label fw-semibold">Data e Hora do Evento</label>
                        <input type="datetime-local" class="form-control" id="data_evento" name="data_evento" required>
                    </div>
                    <div class="col-md-6">
                        <label for="data_recolhimento" class="form-label fw-semibold">Data e Hora de Recolhimento</label>
                        <input type="datetime-local" class="form-control" id="data_recolhimento" name="data_recolhimento">
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="fw-bold">Adicionar Itens ao Orçamento</h5>
                <div id="itens-container" class="mb-3"></div>

                <div class="row g-2 align-items-end p-3 bg-body-tertiary border rounded">
                    <div class="col-md-6">
                        <label for="item-select" class="form-label">Produto ou Kit</label>
                        <select id="item-select" class="form-select">
                            <option value="" disabled selected>Escolha um item...</option>
                            <optgroup label="Produtos">
                                {% for p in produtos %}
                                    <option value="{{ p.id }}" data-tipo="produto" data-estoque="{{ p.quantidade_estoque }}" data-preco="{{ p.preco_repasse }}">
                                        {{ p.nome }} (Estoque: {{ p.quantidade_estoque }})
                                    </option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="Kits Disponíveis">
                                {% for k in kits %}
                                    <option value="{{ k.id }}" data-tipo="kit" data-estoque="1" data-preco="{{ k.valor }}">
                                        {{ k.nome }} (Disponível: 1)
                                    </option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="item-quantidade" class="form-label">Quantidade</label>
                        <input type="number" id="item-quantidade" class="form-control" value="1" min="1">
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-secondary w-100" onclick="adicionarItem()"><i class="bi bi-plus-circle"></i> Adicionar</button>
                    </div>
                </div>

                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="mao_de_obra" class="form-label fw-semibold">Mão de Obra</label>
                        <input type="number" class="form-control" id="mao_de_obra" name="mao_de_obra" placeholder="Digite o valor de Mão de Obra" value="0" onchange="calcularTotal()">
                    </div>
                    <div class="col-md-6">
                        <label for="frete" class="form-label fw-semibold">Frete</label>
                        <input type="number" class="form-control" id="frete" name="frete" placeholder="Digite o valor do Frete" value="0" onchange="calcularTotal()">
                    </div>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold">Valor Total:</h5>
                    <h4 id="valor-total" class="text-success">R$ 0,00</h4>
                </div>

                <div class="d-grid mt-3">
                    <button type="submit" class="btn btn-primary btn-lg fw-bold" id="submit-button">
                        <span id="submit-text">Salvar e Gerar Link de Orçamento</span>
                        <span id="loading-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white">
            <h4 class="my-0 fw-normal"><i class="bi bi-list-check"></i> Orçamentos Salvos e Acompanhamento</h4>
        </div>
        <div class="card-body">
            {% if todos_orcamentos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Evento</th>
                            <th>Cliente</th>
                            <th>Data Evento</th>
                            <th>Valor Total</th>
                            <!-- Nova Coluna -->
                            <th>Valor Pago</th>
                            <!-- Nova Coluna -->
                            <th>Status Pagamento</th>
                            <th>Status Orçamento</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for orcamento in todos_orcamentos %}
                        <!-- Definindo variáveis para o cálculo do status de pagamento (assumindo que valor_pago vem do backend) -->
                        {% set valor_total = orcamento.valor_total %}
                        {% set valor_pago = orcamento.valor_pago | default(0) %}
                        
                        {% set pagamento_total = valor_pago >= valor_total %}
                        {% set pagamento_parcial = valor_pago > 0 and valor_pago < valor_total %}

                        {% if pagamento_total %}
                            {% set status_pagamento = 'Pago' %}
                            {% set badge_pagamento_color = 'bg-success' %}
                        {% elif pagamento_parcial %}
                            {% set status_pagamento = 'Parcial' %}
                            {% set badge_pagamento_color = 'bg-info text-dark' %}
                        {% else %}
                            {% set status_pagamento = 'Pendente' %}
                            {% set badge_pagamento_color = 'bg-danger' %}
                        {% endif %}

                        <tr>
                            <td>{{ orcamento.id }}</td>
                            <td>{{ orcamento.nome_evento }}</td>
                            <td>{{ orcamento.cliente_nome }}</td>
                            <td>{{ orcamento.data_evento.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>R$ {{ "%.2f"|format(orcamento.valor_total) }}</td>
                            <!-- Exibição do Valor Pago -->
                            <td>R$ {{ "%.2f"|format(valor_pago) }}</td>
                            <!-- Exibição do Status de Pagamento -->
                            <td>
                                <span class="badge {{ badge_pagamento_color }}">{{ status_pagamento }}</span>
                            </td>
                            <!-- Status do Orçamento Original -->
                            <td>
                                {% if orcamento.status | lower == 'pendente' %}
                                    <span class="badge bg-warning text-dark">{{ orcamento.status }}</span>
                                {% elif orcamento.status | lower == 'aprovado' %}
                                    <span class="badge bg-success">{{ orcamento.status }}</span>
                                {% elif orcamento.status | lower == 'rejeitado' %}
                                    <span class="badge bg-danger">{{ orcamento.status }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ orcamento.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('ver_orcamento', orcamento_id=orcamento.id) }}" class="btn btn-sm btn-outline-info" title="Visualizar Detalhes">
                                    <i class="bi bi-eye"></i>
                                </a>
                                
                                <!-- Botão de Reenvio -->
                                {% if orcamento.status | lower == 'aprovado' %}
                                    <button class="btn btn-sm btn-outline-primary" title="Orçamento Aprovado - Reenvio Bloqueado" disabled>
                                        <i class="bi bi-envelope-slash"></i>
                                    </button>
                                {% else %}
                                    <form method="POST" action="{{ url_for('reenviar_orcamento', orcamento_id=orcamento.id) }}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja reenviar o e-mail de orçamento para {{ orcamento.cliente_nome }}?');">
                                        <button type="submit" class="btn btn-sm btn-outline-primary" title="Reenviar E-mail">
                                            <i class="bi bi-envelope"></i>
                                        </button>
                                    </form>
                                {% endif %}
                                
                                <!-- NOVO: Botão de Registrar Pagamento -->
                                <!-- O botão só aparece se o status for 'aprovado' E o pagamento não estiver totalizado -->
                                {% if orcamento.status | lower == 'aprovado' and not pagamento_total %}
                                    <a href="{{ url_for('registrar_pagamento', orcamento_id=orcamento.id) }}" class="btn btn-sm btn-outline-success" title="Registrar Pagamento">
                                        <i class="bi bi-currency-dollar"></i>
                                    </a>
                                {% endif %}

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted">Ainda não há orçamentos salvos.</p>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // Função para bloquear datas passadas e adicionar/remover itens.
    document.addEventListener('DOMContentLoaded', function() {
        const dataEventoInput = document.getElementById('data_evento');
        const dataRecolhimentoInput = document.getElementById('data_recolhimento');
        const currentDate = new Date();

        // Formatar a data e hora no formato YYYY-MM-DDTHH:MM
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // Meses começam de 0
        const day = String(currentDate.getDate()).padStart(2, '0');
        const hours = String(currentDate.getHours()).padStart(2, '0');
        const minutes = String(currentDate.getMinutes()).padStart(2, '0');

        const formattedDate = `${year}-${month}-${day}T${hours}:${minutes}`;

        // Definir o valor mínimo para a data do evento e de recolhimento
        dataEventoInput.setAttribute('min', formattedDate);
        dataRecolhimentoInput.setAttribute('min', formattedDate);
    });

    let itemIndex = 0;

    function calcularTotal() {
        let total = 0;
        document.querySelectorAll('#itens-container .item-adicionado').forEach(item => {
            const valor = parseFloat(item.dataset.valor);
            // Verifica se o item tem um input de quantidade (para itens dinâmicos, mas aqui estamos usando data-quantidade)
            const quantidadeInput = item.querySelector('.quantidade-item'); 
            const quantidade = quantidadeInput ? parseInt(quantidadeInput.value) : parseInt(item.dataset.quantidade);
            total += valor * quantidade;
        });

        // Pegando os valores de Mão de Obra e Frete
        const maoDeObra = parseFloat(document.getElementById('mao_de_obra').value) || 0;
        const frete = parseFloat(document.getElementById('frete').value) || 0;
        
        total += maoDeObra + frete;
        document.getElementById('valor-total').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    function adicionarItem() {
        const select = document.getElementById('item-select');
        const quantidadeInput = document.getElementById('item-quantidade');
        const selectedOption = select.options[select.selectedIndex];

        // NOTA: 'alert()' foi substituído por uma função de modal customizado ou log em um ambiente real.
        // No entanto, seguindo o padrão do código original, mantemos o alert() neste arquivo.
        if (!selectedOption || !selectedOption.value) {
            console.error('Por favor, selecione um item.');
            // alert('Por favor, selecione um item.'); // Usar console.error ou modal
            return;
        }

        const quantidadeSolicitada = parseInt(quantidadeInput.value);
        const estoqueDisponivel = parseInt(selectedOption.dataset.estoque);
        const itemTipo = selectedOption.dataset.tipo;
        const itemId = selectedOption.value;

        // Verifica se o item já foi adicionado
        if (document.querySelector(`.item-adicionado[data-id="${itemId}"][data-tipo="${itemTipo}"]`)) {
            console.error('Este item já foi adicionado ao evento.');
            // alert('Este item já foi adicionado ao evento.'); // Usar console.error ou modal
            return;
        }
        
        if (quantidadeSolicitada <= 0) {
            console.error('A quantidade deve ser maior que zero.');
            // alert('A quantidade deve ser maior que zero.'); // Usar console.error ou modal
            return;
        }
        if (quantidadeSolicitada > estoqueDisponivel) {
            console.error(`Erro: Estoque insuficiente! Disponível: ${estoqueDisponivel}`);
            // alert(`Erro: Estoque insuficiente! Disponível: ${estoqueDisponivel}`); // Usar console.error ou modal
            return;
        }

        const itemNome = selectedOption.text.split(' (')[0];
        const itemValor = selectedOption.dataset.preco;

        const itemHtml = ` 
            <div class="alert alert-secondary d-flex justify-content-between align-items-center item-adicionado" id="item-row-${itemIndex}" data-id="${itemId}" data-tipo="${itemTipo}" data-valor="${itemValor}" data-quantidade="${quantidadeSolicitada}">
                <div><strong>${itemNome}</strong><small class="text-muted d-block">Quantidade: ${quantidadeSolicitada}</small></div>
                <button type="button" class="btn-close" aria-label="Close" onclick="removerItem(${itemIndex})"></button>
                <input type="hidden" name="itens[${itemIndex}][id]" value="${itemId}">
                <input type="hidden" name="itens[${itemIndex}][tipo]" value="${itemTipo}">
                <input type="hidden" name="itens[${itemIndex}][quantidade]" value="${quantidadeSolicitada}">
            </div>`;
        
        document.getElementById('itens-container').insertAdjacentHTML('beforeend', itemHtml);
        itemIndex++;
        calcularTotal();
        select.selectedIndex = 0;
        quantidadeInput.value = 1;
    }

    function removerItem(index) {
        document.getElementById(`item-row-${index}`)?.remove();
        calcularTotal();
    }

    // Impede o envio duplo do formulário
    document.querySelector('form').addEventListener('submit', function() {
        const submitButton = document.getElementById('submit-button');
        submitButton.disabled = true;
        document.getElementById('submit-text').style.display = 'none'; // Esconde o texto
        document.getElementById('loading-spinner').style.display = 'inline-block'; // Mostra o carregamento
    });
</script>
{% endblock %}
