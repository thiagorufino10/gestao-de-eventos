{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-person-plus-fill"></i> Cadastro de Cliente</h1>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h4 class="my-0 fw-normal">Novo Cliente</h4>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('cadastro_cliente') }}">
                <!-- DADOS PESSOAIS -->
                <h5 class="fw-semibold">Dados Pessoais</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-6"><input type="text" name="nome" class="form-control" placeholder="Nome Completo" required></div>
                    <div class="col-md-6"><input type="text" name="cpf" id="cpf" class="form-control" placeholder="CPF" required maxlength="14" oninput="formatCPF(this)"></div>
                    <div class="col-md-6"><input type="tel" name="telefone" id="telefone" class="form-control" placeholder="Telefone" maxlength="15" oninput="formatPhone(this)"></div>
                    <div class="col-md-6"><input type="email" name="email" class="form-control" placeholder="E-mail" required></div>
                </div>

                <hr>

                <!-- ENDEREÇO -->
                <h5 class="mt-4 fw-semibold">Endereço</h5>
                
                <!-- CAMPO DE BUSCA DE CEP -->
                <div class="row g-3 mt-2 align-items-end">
                    <div class="col-sm-4">
                        <label for="cep" class="form-label">CEP</label>
                        <input type="text" name="cep" id="cep" class="form-control" placeholder="00000-000" required maxlength="9" oninput="formatCEPInput(this)">
                    </div>
                    <div class="col-sm-8">
                        <button type="button" onclick="searchCEP()" id="cep-button" class="btn btn-secondary w-100">
                            <span id="button-text">Buscar Endereço</span>
                            <span id="loading-indicator" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>
                <div id="cep-message" class="alert alert-danger mt-2 d-none"></div>

                <!-- CAMPOS DE ENDEREÇO -->
                <div class="row g-3 mt-2">
                    <div class="col-md-8">
                        <label for="endereco" class="form-label">Logradouro / Rua</label>
                        <input type="text" name="endereco" id="endereco" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label for="numero" class="form-label">Número</label>
                        <input type="text" name="numero" id="numero" class="form-control" required>
                    </div>
                    <div class="col-md-5">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" name="bairro" id="bairro" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label for="cidade" class="form-label">Cidade</label>
                        <input type="text" name="cidade" id="cidade" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label for="uf" class="form-label">UF</label>
                        <input type="text" name="uf" id="uf" class="form-control" maxlength="2" required>
                    </div>
                    <div class="col-12">
                        <label for="complemento" class="form-label">Complemento (Opcional)</label>
                        <input type="text" name="complemento" id="complemento" class="form-control">
                    </div>
                </div>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg fw-bold">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
             <h4 class="my-0 fw-normal">Clientes Cadastrados</h4>
             <input id="filtro-cliente" type="text" class="form-control" style="width: 300px;" placeholder="Buscar por nome, e-mail ou CPF...">
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead>
                        <tr>
                            <th scope="col" class="ps-3">Nome</th>
                            <th scope="col">CPF</th>
                            <th scope="col">E-mail</th>
                            <th scope="col">Telefone</th>
                            <th scope="col" class="text-end pe-3">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="clientes-body">
                        {% for c in clientes %}
                            {% set cpf = (c.cpf or '') %}
                            {% set cpf_mask = cpf if cpf|length != 11 else (cpf[0:3] ~ '.' ~ cpf[3:6] ~ '.' ~ cpf[6:9] ~ '-' ~ cpf[9:11]) %}
                            {% set tel = (c.telefone or '') %}
                            <tr class="cliente-row" data-index="{{ (c.nome ~ ' ' ~ c.email ~ ' ' ~ cpf)|lower }}">
                                <td class="ps-3 fw-medium">{{ c.nome }}</td>
                                <td>{{ cpf_mask }}</td>
                                <td>{{ c.email }}</td>
                                <td>{{ tel }}</td>
                                <td class="text-end pe-3">
                                    <form method="POST" action="{{ url_for('deletar_cliente', cliente_id=c.id) }}" onsubmit="return confirm('Deseja realmente excluir este cliente?');" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
                                    </form>
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="5" class="text-center p-4">Nenhum cliente cadastrado.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    // Filtro da tabela de clientes
    (function(){
        const filtro = document.getElementById('filtro-cliente');
        if (filtro) {
            filtro.addEventListener('input', function() {
                const q = (this.value || '').trim().toLowerCase();
                document.querySelectorAll('#clientes-body .cliente-row').forEach(tr => {
                    const idx = tr.dataset.index || '';
                    tr.style.display = !q || idx.includes(q) ? '' : 'none';
                });
            });
        }
    })();

    // Funções de formatação de campos
    function formatCEPInput(input) { input.value = input.value.replace(/\D/g, '').replace(/^(\d{5})(\d)/, '$1-$2').substring(0, 9); }
    function formatCPF(input) { input.value = input.value.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2').substring(0, 14); }
    function formatPhone(input) { let v = input.value.replace(/\D/g, '').substring(0, 11); if (v.length > 10) { v = v.replace(/^(\d\d)(\d{5})(\d{4}).*/, '($1) $2-$3'); } else if (v.length > 5) { v = v.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, '($1) $2-$3'); } else if (v.length > 2) { v = v.replace(/^(\d\d)(\d{0,5}).*/, '($1) $2'); } else { v = v.replace(/^(\d*)/, '($1'); } input.value = v; }

    // ==========================================================
    // FUNCIONALIDADE DE BUSCA DE CEP RESTAURADA
    // ==========================================================
    function displayMessage(message, isError = true) {
        const msgElement = document.getElementById('cep-message');
        if (isError && message) {
            msgElement.textContent = message;
            msgElement.classList.remove('d-none');
        } else {
            msgElement.classList.add('d-none');
        }
    }

    async function searchCEP() {
        const cepInput = document.getElementById('cep');
        const cep = cepInput.value.replace(/\D/g, '');
        const cepButton = document.getElementById('cep-button');
        const buttonText = document.getElementById('button-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        displayMessage('', false);
        if (cep.length !== 8) {
            displayMessage('Por favor, digite um CEP válido (8 dígitos).');
            return;
        }

        const apiUrl = `/consulta_cep/${cep}`;
        
        cepButton.disabled = true;
        buttonText.classList.add('d-none');
        loadingIndicator.classList.remove('d-none');
        
        ['endereco', 'bairro', 'cidade', 'uf', 'complemento'].forEach(id => document.getElementById(id).value = '');
        
        try {
            const response = await fetch(apiUrl);
            const data = await response.json();
            
            if (data.erro) {
                displayMessage(data.mensagem || 'CEP não encontrado.');
                document.getElementById('endereco').focus();
            } else {
                document.getElementById('endereco').value = data.logradouro || '';
                document.getElementById('bairro').value = data.bairro || '';
                document.getElementById('cidade').value = data.localidade || '';
                document.getElementById('uf').value = data.uf || '';
                document.getElementById('complemento').value = data.complemento || '';
                document.getElementById('numero').focus();
            }
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
            displayMessage('Erro ao consultar CEP. Tente novamente.');
        } finally {
            cepButton.disabled = false;
            buttonText.classList.remove('d-none');
            loadingIndicator.classList.add('d-none');
        }
    }
</script>
{% endblock %}

