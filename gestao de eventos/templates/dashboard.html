{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
    /* ✅ Estilos atualizados para o novo mini-calendário */
    .mini-calendar .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px; /* Espaçamento visual entre os dias */
    }
    .mini-calendar .day-header {
        text-align: center;
        font-size: 0.75rem;
        font-weight: 500;
        color: #6c757d;
    }
    .mini-calendar .day {
        position: relative;
        text-align: center;
        font-size: 0.8rem;
        aspect-ratio: 1 / 1; /* Células perfeitamente quadradas */
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem; /* Bordas arredondadas */
        transition: background-color 0.2s;
    }
    .mini-calendar .other-month {
        color: #ced4da;
    }
    .mini-calendar .today {
        background-color: #0d6efd;
        color: white;
        border-radius: 50%;
        font-weight: bold;
    }
    /* Destaque para dias com eventos */
    .mini-calendar .has-events {
        background-color: #e0e7ff; /* Fundo azul claro */
        cursor: pointer;
        font-weight: bold;
    }
    /* Garante que o destaque de "hoje" prevaleça sobre o destaque de evento */
    .mini-calendar .has-events.today {
        background-color: #0d6efd;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-speedometer2"></i> Visão Geral</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{{ url_for('eventos') }}" type="button" class="btn btn-sm btn-outline-secondary">Novo Evento</a>
                <a href="{{ url_for('relatorio_eventos') }}" type="button" class="btn btn-sm btn-outline-secondary">Relatórios</a>
            </div>
        </div>
    </div>
    
    <!-- Seção de Cartões de Estatísticas (Stats Cards) -->
    <div class="row g-4 mb-4">
        <!-- Cartão 1: Próximo Evento -->
        <div class="col-md-6 col-lg-3">
            <div class="card text-bg-primary shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Próximo Evento</h5>
                        <i class="bi bi-calendar-check h2"></i>
                    </div>
                    {% if proximo_evento %}
                        <!-- Os dados serão reais se o backend Flask buscar o próximo evento real -->
                        <p class="h3 mt-2" title="{{ proximo_evento.nome_evento }}">{{ proximo_evento.nome_evento | truncate(20, true) }}</p>
                        <p class="card-text text-white-50 mt-2">Em {{ proximo_evento.data_evento.strftime('%d/%m/%Y') }}</p>
                    {% else %}
                        <p class="h3 mt-2">-</p>
                        <p class="card-text text-white-50 mt-2">Nenhum evento agendado</p>
                    {% endif %}
                </div>
                <a href="{{ url_for('calendario_eventos') }}" class="card-footer text-white text-decoration-none">
                    Ver Calendário Completo <i class="bi bi-arrow-right-circle"></i>
                </a>
            </div>
        </div>

        <!-- Cartão 2: Receita do Mês -->
        <div class="col-md-6 col-lg-3">
            <div class="card text-bg-success shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Receita do Mês</h5>
                        <i class="bi bi-cash-coin h2"></i>
                    </div>
                    <!-- Os dados serão reais se 'stats.receita_mes' vier do fluxo de caixa atual -->
                    <p class="h3 mt-2">R$ {{ "%.2f"|format(stats.receita_mes or 0)|replace('.', ',') }}</p>
                    <p class="card-text text-white-50 mt-2">(Dados do Fluxo de Caixa)</p>
                </div>
                <a href="{{ url_for('fluxo_caixa') }}" class="card-footer text-white text-decoration-none">
                    Ver Fluxo de Caixa <i class="bi bi-arrow-right-circle"></i>
                </a>
            </div>
        </div>

        <!-- Cartão 3: Total de Clientes -->
        <div class="col-md-6 col-lg-3">
            <div class="card text-bg-warning shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Clientes</h5>
                        <i class="bi bi-person-plus h2"></i>
                    </div>
                    <!-- Os dados serão reais se 'stats.total_clientes' contar os clientes cadastrados -->
                    <p class="h3 mt-2">{{ stats.total_clientes }}</p>
                    <p class="card-text text-white-50 mt-2">Total de clientes cadastrados</p>
                </div>
                <a href="{{ url_for('cadastro_cliente') }}" class="card-footer text-white text-decoration-none">
                    Cadastrar Cliente <i class="bi bi-arrow-right-circle"></i>
                </a>
            </div>
        </div>

        <!-- Cartão 4: Itens em Estoque -->
        <div class="col-md-6 col-lg-3">
            <div class="card text-bg-info shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Itens em Estoque</h5>
                        <i class="bi bi-box-seam h2"></i>
                    </div>
                    <!-- Os dados serão reais se 'stats.total_itens_estoque' somar as quantidades no estoque -->
                    <p class="h3 mt-2">{{ stats.total_itens_estoque or 0 }}</p>
                    <p class="card-text text-white-50 mt-2">Soma de todas as quantidades</p>
                </div>
                <a href="{{ url_for('consulta_estoque') }}" class="card-footer text-white text-decoration-none">
                    Consultar Estoque <i class="bi bi-arrow-right-circle"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Seção de Últimas Atividades e Mini-Calendário -->
    <div class="row g-4">
        <!-- Coluna de Últimas Atividades -->
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <!-- Título alterado para ser mais abrangente -->
                    <h4 class="my-0 font-weight-normal">Últimas Atividades</h4>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <!-- Iteração única e limpa para exibir eventos ou orçamentos pendentes -->
                        {% for atividade in eventos_recentes %}
                            <li class="list-group-item">
                                {% if atividade.status == 'Pendente' %}
                                    <i class="bi bi-file-earmark-text text-warning me-2"></i>
                                    Orçamento <strong>"{{ atividade.nome_evento }}"</strong> para <strong>{{ atividade.cliente_nome }}</strong> (Pendente).
                                {% else %}
                                    <i class="bi bi-plus-circle-fill text-success me-2"></i>
                                    Evento <strong>"{{ atividade.nome_evento }}"</strong> para <strong>{{ atividade.cliente_nome }}</strong> (Confirmado).
                                {% endif %}
                            </li>
                        {% else %}
                             <li class="list-group-item text-muted">Nenhuma atividade recente encontrada.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Coluna do Mini-Calendário -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <button id="mini-prev-month-btn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-chevron-left"></i></button>
                    <h5 id="mini-month-year-header" class="my-0 fw-normal fs-6"></h5>
                    <button id="mini-next-month-btn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-chevron-right"></i></button>
                </div>
                <div class="card-body mini-calendar">
                    <div class="calendar-grid">
                        <div class="day-header">D</div><div class="day-header">S</div><div class="day-header">T</div><div class="day-header">Q</div><div class="day-header">Q</div><div class="day-header">S</div><div class="day-header">S</div>
                    </div>
                    <div id="mini-calendar-days-grid" class="calendar-grid mt-1">
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // A variável 'todos_eventos' é a que sua rota do dashboard já envia
    // Se o backend estiver enviando dados reais, esta variável JSON terá os dados reais.
    const eventsData = {{ todos_eventos | tojson }};

    // Função auxiliar para converter a data do evento para o formato YYYY-MM-DD
    const eventsByDate = eventsData.reduce((acc, event) => {
        // Assume que 'data_evento' é uma string de data válida (ISO 8601 ou semelhante)
        if (!event.data_evento) return acc;
        
        // Se 'data_evento' já for uma string ISO, usar: new Date(event.data_evento).toISOString().split('T')[0];
        // Se for um timestamp ou outro formato, pode precisar de ajuste. Mantendo a lógica original.
        const dateKey = new Date(event.data_evento).toISOString().split('T')[0];
        
        (acc[dateKey] = acc[dateKey] || []).push(event);
        return acc;
    }, {});

    const monthYearHeader = document.getElementById('mini-month-year-header');
    const calendarDaysGrid = document.getElementById('mini-calendar-days-grid');
    const prevMonthBtn = document.getElementById('mini-prev-month-btn');
    const nextMonthBtn = document.getElementById('mini-next-month-btn');

    let currentDate = new Date();
    currentDate.setDate(1); // Garante que começamos no dia 1 para navegação consistente

    function renderMiniCalendar() {
        calendarDaysGrid.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        monthYearHeader.textContent = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' }).format(currentDate);

        const firstDayOfMonth = new Date(year, month, 1);
        const startDayOfWeek = firstDayOfMonth.getDay(); // 0 (Dom) a 6 (Sáb)
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Células vazias para preencher o início da grade (para alinhar com o dia da semana)
        for (let i = 0; i < startDayOfWeek; i++) {
            calendarDaysGrid.appendChild(document.createElement('div'));
        }
        
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

        // Dias do mês atual
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day';
            dayDiv.textContent = day;
            
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            // Lógica para destacar o "hoje"
            if (dateStr === todayStr && today.getMonth() === month && today.getFullYear() === year) {
                dayDiv.classList.add('today');
            }
            
            // Lógica para marcar os dias com eventos (usando a data real)
            if (eventsByDate[dateStr]) {
                dayDiv.classList.add('has-events');
                const eventTitles = eventsByDate[dateStr]
                    .map(e => `• ${e.nome_evento} (${e.cliente_nome})`) // Inclui o nome do cliente no tooltip
                    .join('\n'); // Usa '\n' para quebra de linha no tooltip

                // Adiciona o tooltip no dia
                dayDiv.setAttribute('data-bs-toggle', 'tooltip');
                dayDiv.setAttribute('data-bs-placement', 'top');
                dayDiv.setAttribute('title', eventTitles);
            }
            
            calendarDaysGrid.appendChild(dayDiv);
        }
        
        // Habilita os tooltips do Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            // Destroi tooltips antigos para evitar duplicatas, se a instância do Bootstrap estiver disponível
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                 const existingTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                 if (existingTooltip) {
                    existingTooltip.dispose();
                 }
                 // Cria um novo tooltip
                 new bootstrap.Tooltip(tooltipTriggerEl);
            }
        });
    }

    // Navegação
    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderMiniCalendar();
    });
    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderMiniCalendar();
    });

    // Renderização inicial do calendário
    renderMiniCalendar();
});
</script>
{% endblock %}
