{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-card-checklist"></i> Controle de Eventos</h1>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <h4 class="my-0 fw-normal">Eventos Agendados</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Evento</th>
                            <th>Cliente</th>
                            <th>Data</th>
                            <th>Total</th>
                            <th>Status de Pagamento</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for evento in eventos %}
                        {% set valor_pago = evento.valor_pago or 0 %}
                        {% set saldo_pendente = evento.valor_total - valor_pago %}
                        
                        <tr>
                            <td>#{{ evento.id }}</td>
                            <td class="fw-bold">{{ evento.nome_evento }}</td>
                            <td>{{ evento.cliente_nome }}</td>
                            <td>{{ evento.data_evento.strftime('%d/%m/%Y') if evento.data_evento }}</td>
                            <td>R$ {{ "%.2f"|format(evento.valor_total)|replace('.', ',') if evento.valor_total else '0,00' }}</td>
                            
                            {# Nova Lógica de Status para melhor visualização #}
                            <td>
                                {% if saldo_pendente <= 0.01 %}
                                    <span class="badge bg-success-subtle border border-success-subtle text-success-emphasis rounded-pill">Pago Total</span>
                                {% elif valor_pago > 0 %}
                                    <span class="badge bg-info-subtle border border-info-subtle text-info-emphasis rounded-pill">Parcial (R$ {{ "%.2f"|format(saldo_pendente)|replace('.', ',') }} pendente)</span>
                                {% else %}
                                    <span class="badge bg-warning-subtle border border-warning-subtle text-warning-emphasis rounded-pill">Pendente</span>
                                {% endif %}
                            </td>
                            
                            <td class="text-end">
                                {# LÓGICA CORRIGIDA: Botão de pagamento só fica ativo se houver saldo pendente #}
                                {% if saldo_pendente > 0.01 %}
                                    <!-- Botão de Registrar Pagamento ATIVO -->
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#paymentModal{{ evento.id }}">
                                        <i class="bi bi-cash-coin"></i> Pagar (R$ {{ "%.2f"|format(saldo_pendente)|replace('.', ',') }})
                                    </button>
                                {% else %}
                                    <!-- Botão de Pagamento DESATIVADO -->
                                    <button class="btn btn-sm btn-success" disabled title="Pagamento integral realizado.">
                                        <i class="bi bi-check-circle"></i> Pago Total
                                    </button>
                                {% endif %}

                                <!-- Outros botões de ação (Finalizar, Excluir, Ver Evento) -->
                                {% if evento.status != 'Finalizado' %}
                                    <a href="{{ url_for('finalizar_evento_form', evento_id=evento.id) }}" class="btn btn-sm btn-outline-success">
                                        <i class="bi bi-check2-circle"></i> Finalizar
                                    </a>
                                {% endif %}

                                <form action="{{ url_for('deletar_evento', evento_id=evento.id) }}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Atenção!\nExcluir este evento irá retornar TODOS os itens ao estoque.\n\nTem certeza que deseja continuar?');">
                                        <i class="bi bi-trash"></i> Excluir
                                    </button>
                                </form>

                                <a href="{{ url_for('ver_evento', evento_id=evento.id) }}" class="btn btn-sm btn-outline-info">
                                    <i class="bi bi-eye"></i> Ver Evento
                                </a>
                            </td>
                        </tr>

                        <!-- Modal para Registrar Pagamento -->
                        <div class="modal fade" id="paymentModal{{ evento.id }}" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="paymentModalLabel">Registrar Pagamento - Evento #{{ evento.id }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <form action="{{ url_for('registrar_pagamento', evento_id=evento.id) }}" method="POST">
                                        <div class="modal-body">
                                            {# Contexto do Pagamento #}
                                            <p class="text-primary fw-bold mb-1">Total do Evento: R$ {{ "%.2f"|format(evento.valor_total)|replace('.', ',') }}</p>
                                            <p class="text-success mb-1">Valor Já Pago: R$ {{ "%.2f"|format(valor_pago)|replace('.', ',') }}</p>
                                            <p class="text-danger fw-bold">Saldo Pendente: R$ {{ "%.2f"|format(saldo_pendente)|replace('.', ',') }}</p>
                                            <hr>

                                            <div class="mb-3">
                                                <label class="form-label">Status do Pagamento</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="pagamento_status" id="total{{ evento.id }}" value="Total">
                                                    <label class="form-check-label" for="total{{ evento.id }}">
                                                        Total (Quita o saldo pendente: R$ {{ "%.2f"|format(saldo_pendente)|replace('.', ',') }})
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="pagamento_status" id="parcial{{ evento.id }}" value="Parcial" checked>
                                                    <label class="form-check-label" for="parcial{{ evento.id }}">
                                                        Parcial (Permite inserir um valor)
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Campo de valor pago, visível por padrão e obrigatório para Pagamento Parcial -->
                                            <div id="valorPagoField{{ evento.id }}" class="mb-3">
                                                <label for="valor_pago" class="form-label">Valor Pago</label>
                                                <input type="number" class="form-control" name="valor_pago" id="valor_pago{{ evento.id }}" step="0.01" required>
                                            </div>

                                            <div class="mb-3">
                                                <label for="meio_pagamento" class="form-label">Meio de Pagamento</label>
                                                <select name="meio_pagamento" class="form-select" required>
                                                    <option value="Cartão">Cartão</option>
                                                    <option value="Dinheiro">Dinheiro</option>
                                                    <option value="Transferência">Transferência</option>
                                                    <option value="Pix">Pix</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-primary">Registrar Pagamento</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Substituí o 'confirm()' por um alerta na interface para evitar bloqueios do navegador.
document.addEventListener('DOMContentLoaded', function () {
    // 1. Lógica para mostrar/esconder o campo de valor pago no modal
    const radios = document.querySelectorAll('input[name="pagamento_status"]');
    radios.forEach(radio => {
        // Encontra o modal pai para garantir que o listener seja acionado quando o modal for aberto
        const modalId = radio.closest('.modal').id;
        const modalElement = document.getElementById(modalId);
        
        // Define a função de toggle
        const toggleValorPagoField = (targetRadio) => {
            const eventoId = targetRadio.id.replace(/[^\d]/g, '');
            const valorPagoField = document.getElementById('valorPagoField' + eventoId);
            const valorPagoInput = document.getElementById('valor_pago' + eventoId);

            if (targetRadio.value === 'Parcial') {
                valorPagoField.style.display = 'block';
                valorPagoInput.required = true;
                // O valor pago parcial deve ser limpo para o usuário inserir o novo valor
                valorPagoInput.value = ''; 
                valorPagoInput.placeholder = 'Digite o valor pago';
            } else {
                valorPagoField.style.display = 'none';
                valorPagoInput.required = false;
                // Para pagamento total, o valor pago deve ser o saldo pendente
                const saldoPendenteElement = targetRadio.closest('.modal-body').querySelector('.text-danger.fw-bold');
                if (saldoPendenteElement) {
                    // Extrai o valor do texto "Saldo Pendente: R$ XX,XX"
                    const saldoText = saldoPendenteElement.textContent.match(/[\d,.]+/)[0].replace('.', '').replace(',', '.');
                    valorPagoInput.value = parseFloat(saldoText);
                }
            }
        };

        // Adiciona listener para a mudança de estado do rádio
        radio.addEventListener('change', function () {
            toggleValorPagoField(this);
        });

        // Configuração inicial ao carregar a página (o padrão é Parcial)
        if (radio.checked) {
             toggleValorPagoField(radio);
        }

    });
});
</script>
{% endblock %}
