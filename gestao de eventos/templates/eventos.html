{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-calendar-plus"></i> Gestão de Eventos</h1>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h4 class="my-0 fw-normal">Cadastrar Novo Evento</h4>
        </div>
        <div class="card-body">
            <form action="{{ url_for('eventos') }}" method="POST">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="tipo_evento" class="form-label fw-semibold">Tipo de Evento</label>
                        <select class="form-select" id="tipo_evento" name="tipo_evento" required>
                            <option value="" selected disabled>Selecione um tipo...</option>
                            <option value="Casamento">Casamento</option>
                            <option value="Festa de 15 Anos">Festa de 15 Anos</option>
                            <option value="Aniversário Infantil">Aniversário Infantil</option>
                            <option value="Aniversário Adulto">Aniversário Adulto</option>
                            <option value="Evento Corporativo">Evento Corporativo</option>
                            <option value="Formatura">Formatura</option>
                            <option value="Outro/Personalizado">Outro/Personalizado</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label for="nome_evento" class="form-label fw-semibold">Nome do Evento</label>
                        <input type="text" class="form-control" id="nome_evento" name="nome_evento" placeholder="Selecione um tipo para preencher ou digite aqui" required>
                    </div>
                    <div class="col-md-12">
                        <label for="cliente_id" class="form-label fw-semibold">Cliente</label>
                        <select class="form-select" id="cliente_id" name="cliente_id" required>
                            <option selected disabled value="">Selecione um cliente...</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- CAMPO DE DATA E HORA AJUSTADO -->
                    <div class="col-md-6">
                        <label for="data_evento" class="form-label fw-semibold">Data e Hora do Evento</label>
                        <input type="datetime-local" class="form-control" id="data_evento" name="data_evento" required>
                    </div>
                    <div class="col-md-6">
                        <label for="recolhimento_evento" class="form-label fw-semibold">Data e Hora de Recolhimento</label>
                        <input type="datetime-local" class="form-control" id="recolhimento_evento" name="recolhimento_evento">
                    </div>
                </div>
                
                <hr class="my-4">

                <h5 class="fw-bold">Adicionar Itens ao Evento</h5>
                <div id="itens-container" class="mb-3"></div>

                <div class="row g-2 align-items-end p-3 bg-body-tertiary border rounded">
                    <div class="col-md-6">
                        <label for="item-select" class="form-label">Produto ou Kit</label>
                        <select id="item-select" class="form-select">
                            <option value="" disabled selected>Escolha um item...</option>
                            <optgroup label="Produtos">
                                {% for produto in produtos %}
                                    <option value="{{ produto.id }}" data-tipo="produto" data-valor="{{ produto.preco_repasse }}" data-estoque="{{ produto.quantidade_estoque }}">
                                        {{ produto.nome }} (Estoque: {{ produto.quantidade_estoque }})
                                    </option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="Kits Disponíveis">
                                {% for kit in kits %}
                                    <option value="{{ kit.id }}" data-tipo="kit" data-valor="{{ kit.valor }}" data-estoque="{{ kit.estoque_disponivel }}">
                                        {{ kit.nome }} (Disponível: {{ kit.estoque_disponivel }})
                                    </option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="item-quantidade" class="form-label">Quantidade</label>
                        <input type="number" id="item-quantidade" class="form-control" value="1" min="1">
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-secondary w-100" onclick="adicionarItem()"><i class="bi bi-plus-circle"></i> Adicionar</button>
                    </div>
                </div>

                <hr class="my-4">
                
                <!-- Mão de obra e frete -->
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="mao_de_obra" class="form-label fw-semibold">Mão de Obra</label>
                        <input type="number" class="form-control" id="mao_de_obra" name="mao_de_obra" placeholder="Digite o valor de Mão de Obra" value="0" onchange="calcularTotal()">
                    </div>
                    <div class="col-md-6">
                        <label for="frete" class="form-label fw-semibold">Frete</label>
                        <input type="number" class="form-control" id="frete" name="frete" placeholder="Digite o valor do Frete" value="0" onchange="calcularTotal()">
                    </div>
                </div>

                <hr class="my-4">

                <div class="row g-3 align-items-end">
                    <div class="col-md-7">
                        <label for="observacoes" class="form-label fw-semibold">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                    </div>
                    <div class="col-md-5">
                        <div class="card text-bg-dark">
                            <div class="card-body text-center">
                                <h6 class="card-title text-white-50">VALOR TOTAL DO EVENTO</h6>
                                <p class="card-text h2 fw-bolder" id="valor-total">R$ 0,00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg fw-bold">Salvar Evento</button>
                </div>
            </form>
        </div>
    </div>
    
    
{% endblock %}

{% block scripts %}
<script>
    // SCRIPT PARA BLOQUEAR DATAS PASSADAS
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        // Ajuste para o fuso horário local (formato YYYY-MM-DDTHH:MM)
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const minDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;

        document.getElementById('data_evento').min = minDateTime;
        document.getElementById('recolhimento_evento').min = minDateTime;
    });

    // SCRIPTS EXISTENTES PARA O FORMULÁRIO
    let itemIndex = 0;

    function calcularTotal() {
        let total = 0;
        document.querySelectorAll('#itens-container .item-adicionado').forEach(item => {
            const valor = parseFloat(item.dataset.valor);
            const quantidadeInput = item.querySelector('.quantidade-item');
            const quantidade = quantidadeInput ? parseInt(quantidadeInput.value) : parseInt(item.dataset.quantidade);
            total += valor * quantidade;
        });

        // Pegando os valores de Mão de Obra e Frete
        const maoDeObra = parseFloat(document.getElementById('mao_de_obra').value) || 0;
        const frete = parseFloat(document.getElementById('frete').value) || 0;
        
        total += maoDeObra + frete;
        document.getElementById('valor-total').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    function adicionarItem() {
        const select = document.getElementById('item-select');
        const quantidadeInput = document.getElementById('item-quantidade');
        const selectedOption = select.options[select.selectedIndex];

        if (!selectedOption || !selectedOption.value) {
            alert('Por favor, selecione um item.');
            return;
        }

        const quantidadeSolicitada = parseInt(quantidadeInput.value);
        const estoqueDisponivel = parseInt(selectedOption.dataset.estoque);
        const itemTipo = selectedOption.dataset.tipo;
        const itemId = selectedOption.value;

        // Verifica se o item já foi adicionado
        if (document.querySelector(`.item-adicionado[data-id="${itemId}"][data-tipo="${itemTipo}"]`)) {
            alert('Este item já foi adicionado ao evento.');
            return;
        }
        
        if (quantidadeSolicitada <= 0) {
            alert('A quantidade deve ser maior que zero.');
            return;
        }
        if (quantidadeSolicitada > estoqueDisponivel) {
            alert(`Erro: Estoque insuficiente! Disponível: ${estoqueDisponivel}`);
            return;
        }

        const itemNome = selectedOption.text.split(' (')[0];
        const itemValor = selectedOption.dataset.valor;

        const isKit = itemTipo === 'kit';
        const quantidadeField = isKit ? 
            `<small class="text-muted d-block">Quantidade: ${quantidadeSolicitada}</small>` : 
            `<div class="d-flex align-items-center"><label for="qtd-${itemIndex}" class="form-label me-2 mb-0 small">Qtd:</label><input type="number" id="qtd-${itemIndex}" class="form-control form-control-sm quantidade-item" value="${quantidadeSolicitada}" min="1" max="${estoqueDisponivel}" style="width: 80px;" onchange="calcularTotal()"></div>`;


        const itemHtml = `
            <div class="alert alert-secondary d-flex justify-content-between align-items-center item-adicionado" id="item-row-${itemIndex}" data-valor="${itemValor}" data-id="${itemId}" data-tipo="${itemTipo}" data-quantidade="${quantidadeSolicitada}">
                <div>
                    <strong>${itemNome}</strong>
                    <small class="text-muted d-block">Valor Unit.: R$ ${parseFloat(itemValor).toFixed(2).replace('.', ',')}</small>
                </div>
                <div class="d-flex align-items-center">
                    ${quantidadeField}
                    <button type="button" class="btn-close ms-3" aria-label="Close" onclick="removerItem(${itemIndex})"></button>
                </div>
                <input type="hidden" name="itens[${itemIndex}][id]" value="${itemId}">
                <input type="hidden" name="itens[${itemIndex}][tipo]" value="${itemTipo}">
                <input type="hidden" name="itens[${itemIndex}][quantidade]" value="${quantidadeSolicitada}" class="hidden-quantidade">
            </div>`;
        
        document.getElementById('itens-container').insertAdjacentHTML('beforeend', itemHtml);
        itemIndex++;
        calcularTotal();
        select.selectedIndex = 0;
        quantidadeInput.value = 1;
    }
    
    function removerItem(index) {
        document.getElementById(`item-row-${index}`)?.remove();
        calcularTotal();
    }
    
    document.getElementById('tipo_evento').addEventListener('change', function() {
        const nomeEventoInput = document.getElementById('nome_evento');
        if (this.value === 'Outro/Personalizado') {
            nomeEventoInput.value = '';
            nomeEventoInput.placeholder = 'Digite o nome personalizado do evento';
            nomeEventoInput.focus();
        } else if (this.value) {
            nomeEventoInput.value = this.value;
        }
    });

    document.querySelector('form').addEventListener('submit', function() {
        document.querySelectorAll('.item-adicionado').forEach(item => {
            const visibleInput = item.querySelector('.quantidade-item');
            const hiddenInput = item.querySelector('.hidden-quantidade');
            if (visibleInput && hiddenInput) {
                hiddenInput.value = visibleInput.value;
            }
        });
    });
</script>
{% endblock %}
