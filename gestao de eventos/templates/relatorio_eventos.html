{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-graph-up"></i> Relatórios de Eventos</h1>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="my-1 fw-normal"><i class="bi bi-funnel-fill"></i> Filtrar Relatório</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('relatorio_eventos') }}">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="data_inicio" class="form-label">Data de Início</label>
                        <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio or '' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="data_fim" class="form-label">Data de Fim</label>
                        <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim or '' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="tipo_filtro" class="form-label">Tipo de Evento</label>
                        <select id="tipo_filtro" name="tipo_filtro" class="form-select">
                            <option value="todos" {% if tipo_filtro == 'todos' %}selected{% endif %}>Todos os Tipos</option>
                            {% for tipo in tipos_de_evento %}
                            <option value="{{ tipo.tipo_evento }}" {% if tipo_filtro == tipo.tipo_evento %}selected{% endif %}>{{ tipo.tipo_evento }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="tipo_pagamento" class="form-label">Tipo de Pagamento</label>
                        <select id="tipo_pagamento" name="tipo_pagamento" class="form-select">
                            <option value="todos" {% if tipo_pagamento_filtro == 'todos' %}selected{% endif %}>Todos os Tipos</option>
                            <option value="Pendente" {% if tipo_pagamento_filtro == 'Pendente' %}selected{% endif %}>Pendente</option>
                            <option value="Total" {% if tipo_pagamento_filtro == 'Total' %}selected{% endif %}>Pago Total</option>
                            <option value="Parcial" {% if tipo_pagamento_filtro == 'Parcial' %}selected{% endif %}>Pago Parcial</option>
                            <option value="Pix" {% if tipo_pagamento_filtro == 'Pix' %}selected{% endif %}>Pix</option>
                            <option value="Transferência" {% if tipo_pagamento_filtro == 'Transferência' %}selected{% endif %}>Transferência</option>
                            <option value="Dinheiro" {% if tipo_pagamento_filtro == 'Dinheiro' %}selected{% endif %}>Dinheiro</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex">
                        <button type="submit" class="btn btn-primary w-100 me-2"><i class="bi bi-search"></i> Filtrar</button>
                        <a id="export-btn" href="#" class="btn btn-success w-100" title="Exportar para Excel"><i class="bi bi-file-earmark-excel-fill"></i> Exportar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Estatísticas do Relatório -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h4 class="my-0 fw-normal">Resumo do Período</h4>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card text-bg-primary text-center h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total de Eventos</h5>
                            <p class="card-text display-4 fw-bold">{{ stats.total_filtrado }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card text-bg-info text-center h-100">
                        <div class="card-body">
                            <h5 class="card-title">Valor Faturado</h5>
                            <p class="card-text display-6 fw-bold">R$ {{ "%.2f"|format(stats.valor_total_filtrado|float) }}</p>
                        </div>
                    </div>
                </div>
                {% for item in stats.eventos_por_status %}
                <div class="col-md-6 col-lg-3">
                    {% set status_lower = item.status|lower %}
                    {% if 'finalizado' in status_lower and 'parcial' not in status_lower %}{% set card_class = 'text-bg-success' %}
                    {% elif 'parcial' in status_lower %}{% set card_class = 'text-bg-warning' %}
                    {% else %}{% set card_class = 'text-bg-secondary' %}
                    {% endif %}
                    <div class="card {{ card_class }} text-center h-100">
                        <div class="card-body">
                            <h5 class="card-title">"{{ item.status }}"</h5>
                            <p class="card-text display-4 fw-bold">{{ item.count }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Lista de Eventos -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="my-1 fw-normal">Lista de Eventos</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Nome do Evento</th>
                            <th>Cliente</th>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Status de Pagamento</th>
                            <th class="text-end">Valor Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for evento in eventos_filtrados %}
                        <tr>
                            <td>{{ evento.nome_evento }}</td>
                            <td>{{ evento.cliente_nome }}</td>
                            <td>{{ evento.data_evento.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>{{ evento.tipo_evento }}</td>
                            <td><span class="badge 
                                {% if evento.status == 'Finalizado' %}text-bg-success
                                {% elif evento.status == 'Finalização Parcial' %}text-bg-warning
                                {% else %}text-bg-secondary{% endif %}">{{ evento.status }}</span>
                            </td>
                            <td><span class="badge 
                                {% if evento.status_pagamento == 'Pendente' %}bg-warning
                                {% elif evento.status_pagamento == 'Total' %}bg-success
                                {% elif evento.status_pagamento == 'Parcial' %}bg-info
                                {% elif evento.status_pagamento == 'Pix' %}bg-primary
                                {% elif evento.status_pagamento == 'Transferência' %}bg-secondary
                                {% elif evento.status_pagamento == 'Dinheiro' %}bg-light{% endif %}">{{ evento.status_pagamento }}</span>
                            </td>
                            <td class="text-end">R$ {{ "%.2f"|format(evento.valor_total|float) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center">Nenhum evento encontrado para os filtros selecionados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const exportBtn = document.getElementById('export-btn');

    exportBtn.addEventListener('click', function(e) {
        e.preventDefault(); // Impede o link de navegar

        // Pega os valores atuais dos filtros
        const dataInicio = document.getElementById('data_inicio').value;
        const dataFim = document.getElementById('data_fim').value;
        const tipoFiltro = document.getElementById('tipo_filtro').value;
        const tipoPagamentoFiltro = document.getElementById('tipo_pagamento').value;

        // Constrói os parâmetros da URL
        const params = new URLSearchParams({
            data_inicio: dataInicio,
            data_fim: dataFim,
            tipo_filtro: tipoFiltro,
            tipo_pagamento: tipoPagamentoFiltro
        });

        // Cria a URL de exportação e aciona o download
        const exportUrl = `{{ url_for('exportar_relatorio_eventos') }}?${params.toString()}`;
        window.location.href = exportUrl;
    });
});
</script>

{% endblock %}
