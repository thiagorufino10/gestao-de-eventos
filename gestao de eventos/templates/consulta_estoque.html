{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-search"></i> Consulta de Estoque</h1>
    </div>

    <!-- Card de Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h4 class="my-0 fw-normal">Filtros</h4>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="tipo-select" class="form-label">Filtrar por Tipo</label>
                    <select id="tipo-select" class="form-select">
                        <option value="all">Todos</option>
                        <option value="aluguel">Aluguel</option>
                        <option value="descartavel">Descartáveis</option>
                        <option value="venda">Venda</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="unit-select" class="form-label">Filtrar por Unidade</label>
                    <select id="unit-select" class="form-select">
                        <option value="">Todas</option>
                        <option value="unidade">Unidade</option>
                        <option value="pacote">Pacote</option>
                        <option value="caixa">Caixa</option>
                        <option value="saco">Saco</option>
                        <option value="pote">Pote</option>
                        <option value="metro">Metro</option>
                        <option value="litro">Litro</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="search-input" class="form-label">Buscar por Nome</label>
                    <input id="search-input" type="text" placeholder="Digite o nome do material..." class="form-control">
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Materiais -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h4 class="my-0 fw-normal">Materiais em Estoque</h4>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">Nome</th>
                            <th>Tipo</th>
                            <th>Unidade</th>
                            <th class="text-end">Qtd. Estoque</th>
                            <th class="text-end">Qtd. Total Itens</th>
                            <th class="text-end">Preço Compra</th>
                            <th class="text-end">Valor Total</th>
                            <th class="text-center pe-3">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="estoque-table-body">
                        {% for material in materiais %}
                            {% set unidade_l = (material.unidade_medida or '')|lower %}
                            {% set is_pack_unit = unidade_l in ['pacote', 'caixa', 'saco', 'pote'] %}
                            <tr class="material-row"
                                data-nome="{{ (material.nome or '')|lower }}"
                                data-tipo="{{ (material.tipo_material or '')|lower }}"
                                data-unidade="{{ unidade_l }}">
                                <td class="ps-3 fw-medium">{{ material.nome }}</td>
                                <td class="text-capitalize">{{ material.tipo_material }}</td>
                                <td>{{ material.unidade_medida }}</td>
                                <td class="text-end">{{ material.quantidade_estoque }}</td>
                                <td class="text-end">
                                    {% if is_pack_unit %}
                                        {{ (material.quantidade_venda or 0) * (material.quantidade_estoque or 0) }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                                <td class="text-end">R$ {{ "%.2f"|format(material.preco_compra or 0)|replace('.', ',') }}</td>
                                <td class="text-end material-total">R$ {{ "%.2f"|format((material.quantidade_estoque or 0) * (material.preco_compra or 0))|replace('.', ',') }}</td>
                                <td class="text-center pe-3">
                                    {% if material.foto_path %}
                                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#modal-foto" data-bs-src="{{ url_for('static', filename=material.foto_path) }}">
                                            Ver Foto
                                        </button>
                                    {% endif %}
                                    <form method="POST" action="{{ url_for('deletar_material', material_id=material.id) }}" onsubmit="return confirm('Deseja realmente excluir este produto?');" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
                                    </form>
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="8" class="text-center p-4">Nenhum material cadastrado.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div id="empty-state" class="d-none text-center text-muted p-5 border-top">
                <p>Nenhum item encontrado com os filtros atuais.</p>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            <div id="count-info" class="text-muted small">—</div>
            <div>
                <span class="fw-semibold">Somatório dos itens visíveis:</span>
                <span id="total-geral" class="fw-bold fs-5 ms-2">R$ 0,00</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar foto -->
<div class="modal fade" id="modal-foto" tabindex="-1" aria-labelledby="modalFotoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalFotoLabel">Foto do Produto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modal-foto-img" src="" alt="Foto do Produto" class="img-fluid rounded" style="max-height: 80vh;">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const tipoSelect = document.getElementById('tipo-select');
    const searchInput = document.getElementById('search-input');
    const unitSelect = document.getElementById('unit-select');
    const tableBody = document.getElementById('estoque-table-body');
    const totalSpan = document.getElementById('total-geral');
    const emptyState = document.getElementById('empty-state');
    const countInfo = document.getElementById('count-info');

    function moedaBR(v) { return 'R$ ' + (v || 0).toFixed(2).replace('.', ','); }

    function aplicaFiltros() {
        const tipoFiltro = tipoSelect.value.toLowerCase();
        const q = searchInput.value.trim().toLowerCase();
        const unidadeF = unitSelect.value.toLowerCase();

        let visiveis = 0;
        let total = 0;
        const rows = tableBody.querySelectorAll('.material-row');

        rows.forEach(row => {
            const nome = row.dataset.nome || '';
            const tipo = row.dataset.tipo || '';
            const unidade = row.dataset.unidade || '';

            const passaTipo = (tipoFiltro === 'all') || (tipo === tipoFiltro);
            const passaBusca = !q || nome.includes(q);
            const passaUnidade = !unidadeF || (unidade === unidadeF);

            const mostrar = passaTipo && passaBusca && passaUnidade;
            row.style.display = mostrar ? '' : 'none';

            if (mostrar) {
                visiveis++;
                const totalTd = row.querySelector('.material-total').textContent || 'R$ 0,00';
                const val = parseFloat(totalTd.replace('R$', '').replace(/\./g, '').replace(',', '.')) || 0;
                total += val;
            }
        });

        emptyState.classList.toggle('d-none', visiveis > 0 || rows.length === 0);
        countInfo.textContent = `${visiveis} de ${rows.length} item(ns) exibido(s)`;
        totalSpan.textContent = moedaBR(total);
    }

    // Adiciona os gatilhos para a função de filtro
    tipoSelect.addEventListener('change', aplicaFiltros);
    searchInput.addEventListener('input', aplicaFiltros);
    unitSelect.addEventListener('change', aplicaFiltros);

    // Lógica para o modal de visualização de foto do Bootstrap
    const modalFoto = document.getElementById('modal-foto');
    if (modalFoto) {
        modalFoto.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const imgSrc = button.getAttribute('data-bs-src');
            const modalImage = modalFoto.querySelector('#modal-foto-img');
            modalImage.src = imgSrc;
        });
    }

    // Executa os filtros na carga inicial da página
    aplicaFiltros();
});
</script>
{% endblock %}
