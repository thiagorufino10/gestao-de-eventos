{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
    /* Estilos para o novo calendário profissional */
    .calendar-body { height: calc(100vh - 200px); } /* Altura dinâmica */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: auto repeat(5, 1fr);
        height: 100%;
    }
    .day-cell {
        border: 1px solid #e9ecef;
        padding: 8px;
        transition: background-color 0.2s;
        overflow-y: auto;
    }
    .day-cell:not(.other-month):hover { background-color: #90bce7; }
    .day-number { font-size: 0.8rem; font-weight: 500; }
    .day-cell.today .day-number {
        background-color: #0d6efd;
        color: rgb(255, 255, 255);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .day-cell.other-month { background-color: #f8f9fa; color: #adb5bd; }
    
    /* Estilos dos "Chips" de Evento */
    .event-chip {
        font-size: 0.75rem;
        padding: 3px 6px;
        border-radius: 4px;
        margin-top: 4px;
        color: rgb(0, 0, 0);
        cursor: pointer;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .event-chip[data-status="Agendado"] { background-color: #0d6efd; }
    .event-chip[data-status="Finalizado"] { background-color: #198754; }
    .event-chip[data-status="Finalização Parcial"] { background-color: #ffc107; color: black; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2"><i class="bi bi-calendar3-week"></i> Calendário de Eventos</h1>
        <p class="text-muted">Visualize e gerencie seus compromissos.</p>
    </div>
    <div id="calendar-header" class="d-flex align-items-center gap-3">
        <button id="today-btn" class="btn btn-outline-secondary btn-sm">Hoje</button>
        <div>
            <button id="prev-month-btn" class="btn btn-light btn-sm"><i class="bi bi-chevron-left"></i></button>
            <button id="next-month-btn" class="btn btn-light btn-sm"><i class="bi bi-chevron-right"></i></button>
        </div>
        <h4 id="month-year-header" class="my-0 fw-normal fs-5"></h4>
    </div>
</div>

<div class="row g-0">
    <div class="col-md-9">
        <div class="bg-white rounded-start shadow-sm border border-end-0">
            <div class="d-grid" style="grid-template-columns: repeat(7, 1fr);">
                <div class="text-center small fw-bold text-muted p-2 border-bottom">DOM</div>
                <div class="text-center small fw-bold text-muted p-2 border-bottom">SEG</div>
                <div class="text-center small fw-bold text-muted p-2 border-bottom">TER</div>
                <div class="text-center small fw-bold text-muted p-2 border-bottom">QUA</div>
                <div class="text-center small fw-bold text-muted p-2 border-bottom">QUI</div>
                <div class="text-center small fw-bold text-muted p-2 border-bottom">SEX</div>
                <div class="text-center small fw-bold text-muted p-2 border-bottom">SÁB</div>
            </div>
            <div id="calendar-grid" class="calendar-grid">
                </div>
        </div>
    </div>
    <div class="col-md-3">
        <div id="details-sidebar" class="bg-light p-3 h-100 rounded-end shadow-sm border">
            <h5 id="details-date" class="border-bottom pb-2">Selecione um dia</h5>
            <div id="details-content" class="mt-3">
                <p class="text-muted small">Clique em um dia no calendário para ver os eventos.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="eventModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><i class="bi bi-person me-2"></i><strong>Cliente:</strong> <span id="eventModalClient"></span></p>
                <p><i class="bi bi-clock me-2"></i><strong>Data e Hora:</strong> <span id="eventModalDateTime"></span></p>
                <p><i class="bi bi-info-circle me-2"></i><strong>Status:</strong> <span id="eventModalStatus" class="badge"></span></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const eventsData = {{ eventos | tojson }};
    const eventsByDate = eventsData.reduce((acc, event) => {
        if (!event.data_evento) return acc;
        const dateKey = new Date(event.data_evento).toISOString().split('T')[0];
        (acc[dateKey] = acc[dateKey] || []).push(event);
        return acc;
    }, {});

    const calendarGrid = document.getElementById('calendar-grid');
    const monthYearHeader = document.getElementById('month-year-header');
    const detailsDate = document.getElementById('details-date');
    const detailsContent = document.getElementById('details-content');
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    
    let currentDate = new Date();

    function renderCalendar() {
        calendarGrid.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthYearHeader.textContent = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' }).format(currentDate);

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Preenche os dias vazios do início
        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'day-cell other-month';
            calendarGrid.appendChild(emptyCell);
        }

        // Renderiza os dias do mês
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell';
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayCell.classList.add('today');
            }
            
            dayCell.innerHTML = `<div class="day-number">${day}</div><div class="event-list"></div>`;
            
            // Adiciona os eventos
            if (eventsByDate[dateStr]) {
                const eventList = dayCell.querySelector('.event-list');
                eventsByDate[dateStr].slice(0, 3).forEach(event => { // Mostra até 3 eventos
                    const eventChip = document.createElement('div');
                    eventChip.className = 'event-chip';
                    eventChip.textContent = event.nome_evento;
                    eventChip.dataset.status = event.status || 'Agendado';
                    eventChip.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showEventModal(event);
                    });
                    eventList.appendChild(eventChip);
                });

                if (eventsByDate[dateStr].length > 3) {
                    const moreLink = document.createElement('a');
                    moreLink.href = '#';
                    moreLink.className = 'text-primary small fw-bold mt-1 d-block';
                    moreLink.textContent = `+${eventsByDate[dateStr].length - 3} mais`;
                    eventList.appendChild(moreLink);
                }
            }

            dayCell.addEventListener('click', () => showDayDetails(new Date(year, month, day)));
            calendarGrid.appendChild(dayCell);
        }
    }

    function showDayDetails(date) {
        detailsDate.textContent = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full' }).format(date);
        const dateKey = date.toISOString().split('T')[0];
        const dayEvents = eventsByDate[dateKey] || [];
        
        if (dayEvents.length > 0) {
            let content = '<ul class="list-unstyled">';
            dayEvents.forEach(event => {
                const status = event.status || 'Agendado';
                let statusClass = 'primary';
                if (status === 'Finalizado') statusClass = 'success';
                if (status === 'Finalização Parcial') statusClass = 'warning';

                content += `<li class="mb-2 p-2 rounded bg-white border-start border-5 border-${statusClass}">
                                <div class="fw-bold">${event.nome_evento}</div>
                                <div class="small text-muted">${event.cliente_nome}</div>
                            </li>`;
            });
            content += '</ul>';
            detailsContent.innerHTML = content;
        } else {
            detailsContent.innerHTML = '<p class="text-muted small">Nenhum evento para este dia.</p>';
        }
    }

    function showEventModal(event) {
        document.getElementById('eventModalTitle').textContent = event.nome_evento;
        document.getElementById('eventModalClient').textContent = event.cliente_nome;
        const eventDate = new Date(event.data_evento);
        document.getElementById('eventModalDateTime').textContent = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'long', timeStyle: 'short' }).format(eventDate);
        
        const statusBadge = document.getElementById('eventModalStatus');
        const status = event.status || 'Agendado';
        statusBadge.textContent = status;
        statusBadge.className = 'badge'; // Reset classes
        if (status === 'Finalizado') statusBadge.classList.add('bg-success');
        else if (status === 'Finalização Parcial') statusBadge.classList.add('bg-warning', 'text-dark');
        else statusBadge.classList.add('bg-primary');

        eventModal.show();
    }

    // Navegação
    document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
    document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
    document.getElementById('today-btn').addEventListener('click', () => { currentDate = new Date(); renderCalendar(); });

    renderCalendar();
    showDayDetails(new Date()); // Mostra detalhes do dia de hoje ao carregar
});
</script>
{% endblock %}